\ProvidesPackage{physics-patch}
% physics-patch 2.1
%
% Improved version of the physics package
%
% This package is released under the LaTeX Project Public License (LPPL) 1.3c
% See https://www.latex-project.org/lppl/lppl-1-3c for the details of that license
% Many parts of this package are modified from the physics package, created by Sergio C. de la Barrera and licenced under LPPL 1.3
% See https://ctan.org/pkg/physics for the details of that package
%
% This package requires amsmath, etoolbox, xcolor, xparse, and xstring package.
% Commands that have different definitions come with PT in the beginning of their name (e.g. \PTmqty).
% physics-patch has covered all commands in physics since version 2.0, so there's no need to load physics.
% It is ok to load physics before this package. This package will silently overrides macros in physics with an improved version. To use the original version provided by physics, load physics before this package and use the nooverride option (not recommended).
% This package pretends that physics package is loaded so that this package won't be overriden if loading physics is called afterward and packages loaded afterward that checks whether physics is loaded to determine its behavior (e.g. siunitx) work correctly. To disable this, use the nopretend option (not recommended).
% If siuitx is loaded before this package, this package will define \ITquantity and \ITqty as the integration of the improved definition of physics's \qty (in \PHquantity and \PHqty) and siuitx's \SI. You can optionally set siintegrate option to override \PTquantity and \PTqty with \ITqty (not recommended).
%
% Author: Willie Shen (Willie169)
% Repository: https://github.com/Willie169/physics-patch
% Last update: Feb 16, 2025
%
% For documentation, see physics-patch.pdf

\RequirePackage{amsmath}
\RequirePackage{etoolbox}
\RequirePackage{xcolor}
\RequirePackage{xparse}
\RequirePackage{xstring}

% Options
\newif\ifoverride
\DeclareOption{override}{\overridetrue} % Override macros in physics to patched ones. (default) This option can be set no matter whether physics is loaded
\DeclareOption{nooverride}{\overridefalse} % Not override macros in physics to patched ones. (not recommended) Fall back to override if physics is not loaded
\newif\ifpretend
\DeclareOption{pretend}{\pretendtrue} % Pretend that physics package is loaded so that this package won't be overriden if \@onefilewithoptions{physics} is called afterward (e.g. \usepackage{physics}) and packages loaded afterward that checks whether physics is loaded to determine its behavior (e.g. siunitx) work correctly (default)
\DeclareOption{nopretend}{\pretendfalse} % Not pretend that physics package is loaded
\newif\ifsiintegrate
\DeclareOption{siintegrate}{\siintegratetrue} % Override \PTquantity and \PTqty with \ITqty (not recommended). Fall back to nosiintegrate if siunitx is not loaded
\DeclareOption{nosiintegrate}{\siintegratefalse} % Not override \PTquantity and \PTqty with \ITqty (default)
\newif\iforiginaldiv
\DeclareOption{originaldiv}{\originaldivtrue} % Let \div be division symbol (default)
\DeclareOption{nooriginaldiv}{\originaldivfalse} % Let \div be \divergence
\DeclareOption{trig}{\let\trigopt = 1} % Redefine trig function and operator (default)
\DeclareOption{notrig}{\let\trigopt = 0} % Not redefine trig function and operator
\DeclareOption{uprightdiff}{\def\diffd{\mathrm{d}}} % Upright differentials (default)
\DeclareOption{italicdiff}{\def\diffd{d}} % Italic differentials
\DeclareOption{bolddel}{\DeclareDocumentCommand\vnabla{}{\boldsymbol\nabla}} % Vector bold \nabla symbol (default)
\DeclareOption{arrowdel}{\DeclareDocumentCommand\vnabla{}{\vec{\boldsymbol\nabla}}} % Vector arrow \nabla symbol
\newif\ifshortgreek
\DeclareOption{shortgreek}{\shortgreektrue} % Define shorthands for Greek letters
\DeclareOption{noshortgreek}{\shortgreekfalse} % Not define shorthands for Greek letters (default)
\DeclareOption*{}
\ExecuteOptions{override,pretend,nosiintegrate,originaldiv,trig,uprightdiff,bolddel,noshortgreek,noshortalphabet}
\ProcessOptions\relax

\newif\ifphysics
\IfPackageLoadedTF{physics}{\physicstrue}{\overridetrue\physicsfalse}

\ifpretend
  \makeatletter
  \@namedef{ver@physics.sty}{9999/99/99}
  \makeatother
\fi

% Shorthands for Greek letters
\ifshortgreek
\DeclareDocumentCommand{\tgAlpha}{O{}}{\text{\textAlpha}}
\DeclareDocumentCommand{\tgBeta}{O{}}{\text{\textBeta}}
\DeclareDocumentCommand{\tgGamma}{O{}}{\text{\textGamma}}
\DeclareDocumentCommand{\tgDelta}{O{}}{\text{\textDelta}}
\DeclareDocumentCommand{\tgEpsilon}{O{}}{\text{\textEpsilon}}
\DeclareDocumentCommand{\tgZeta}{O{}}{\text{\textZeta}}
\DeclareDocumentCommand{\tgEta}{O{}}{\text{\textEta}}
\DeclareDocumentCommand{\tgTheta}{O{}}{\text{\textTheta}}
\DeclareDocumentCommand{\tgIota}{O{}}{\text{\textIota}}
\DeclareDocumentCommand{\tgKappa}{O{}}{\text{\textKappa}}
\DeclareDocumentCommand{\tgLambda}{O{}}{\text{\textLambda}}
\DeclareDocumentCommand{\tgMu}{O{}}{\text{\textMu}}
\DeclareDocumentCommand{\tgNu}{O{}}{\text{\textNu}}
\DeclareDocumentCommand{\tgXi}{O{}}{\text{\textXi}}
\DeclareDocumentCommand{\tgOmicron}{O{}}{\text{\textOmicron}}
\DeclareDocumentCommand{\tgPi}{O{}}{\text{\textPi}}
\DeclareDocumentCommand{\tgRho}{O{}}{\text{\textRho}}
\DeclareDocumentCommand{\tgSigma}{O{}}{\text{\textSigma}}
\DeclareDocumentCommand{\tgTau}{O{}}{\text{\textTau}}
\DeclareDocumentCommand{\tgUpsilon}{O{}}{\text{\textUpsilon}}
\DeclareDocumentCommand{\tgPhi}{O{}}{\text{\textPhi}}
\DeclareDocumentCommand{\tgChi}{O{}}{\text{\textChi}}
\DeclareDocumentCommand{\tgPsi}{O{}}{\text{\textPsi}}
\DeclareDocumentCommand{\tgOmega}{O{}}{\text{\textOmega}}
\DeclareDocumentCommand{\tgalpha}{O{}}{\text{\textalpha}}
\DeclareDocumentCommand{\tgbeta}{O{}}{\text{\textbeta}}
\DeclareDocumentCommand{\tggamma}{O{}}{\text{\textgamma}}
\DeclareDocumentCommand{\tgdelta}{O{}}{\text{\textdelta}}
\DeclareDocumentCommand{\tgepsilon}{O{}}{\text{\textepsilon}}
\DeclareDocumentCommand{\tgzeta}{O{}}{\text{\textzeta}}
\DeclareDocumentCommand{\tgeta}{O{}}{\text{\texteta}}
\DeclareDocumentCommand{\tgtheta}{O{}}{\text{\texttheta}}
\DeclareDocumentCommand{\tgiota}{O{}}{\text{\textiota}}
\DeclareDocumentCommand{\tgkappa}{O{}}{\text{\textkappa}}
\DeclareDocumentCommand{\tglambda}{O{}}{\text{\textlambda}}
\DeclareDocumentCommand{\tgmu}{O{}}{\text{\textmu}}
\DeclareDocumentCommand{\tgnu}{O{}}{\text{\textnu}}
\DeclareDocumentCommand{\tgxi}{O{}}{\text{\textxi}}
\DeclareDocumentCommand{\tgomicron}{O{}}{\text{\textomicron}}
\DeclareDocumentCommand{\tgpi}{O{}}{\text{\textpi}}
\DeclareDocumentCommand{\tgrho}{O{}}{\text{\textrho}}
\DeclareDocumentCommand{\tgsigma}{O{}}{\text{\textsigma}}
\DeclareDocumentCommand{\tgtau}{O{}}{\text{\texttau}}
\DeclareDocumentCommand{\tgupsilon}{O{}}{\text{\textupsilon}}
\DeclareDocumentCommand{\tgphi}{O{}}{\text{\textphi}}
\DeclareDocumentCommand{\tgchi}{O{}}{\text{\textchi}}
\DeclareDocumentCommand{\tgpsi}{O{}}{\text{\textpsi}}
\DeclareDocumentCommand{\tgomega}{O{}}{\text{\textomega}}
\DeclareDocumentCommand{\vAlpha}{}{\varAlpha}
\DeclareDocumentCommand{\vBeta}{}{\varBeta}
\DeclareDocumentCommand{\vGamma}{}{\varGamma}
\DeclareDocumentCommand{\vDelta}{}{\varDelta}
\DeclareDocumentCommand{\vEpsilon}{}{\varEpsilon}
\DeclareDocumentCommand{\vZeta}{}{\varZeta}
\DeclareDocumentCommand{\vEta}{}{\varEta}
\DeclareDocumentCommand{\vTheta}{}{\varTheta}
\DeclareDocumentCommand{\vIota}{}{\varIota}
\DeclareDocumentCommand{\vKappa}{}{\varKappa}
\DeclareDocumentCommand{\vLambda}{}{\varLambda}
\DeclareDocumentCommand{\vMu}{}{\varMu}
\DeclareDocumentCommand{\vNu}{}{\varNu}
\DeclareDocumentCommand{\vXi}{}{\varXi}
\DeclareDocumentCommand{\vOmicron}{}{\varOmicron}
\DeclareDocumentCommand{\vPi}{}{\varPi}
\DeclareDocumentCommand{\vRho}{}{\varRho}
\DeclareDocumentCommand{\vSigma}{}{\varSigma}
\DeclareDocumentCommand{\vTau}{}{\varTau}
\DeclareDocumentCommand{\vUpsilon}{}{\varUpsilon}
\DeclareDocumentCommand{\vPhi}{}{\varPhi}
\DeclareDocumentCommand{\vChi}{}{\varChi}
\DeclareDocumentCommand{\vPsi}{}{\varPsi}
\DeclareDocumentCommand{\vOmega}{}{\varOmega}
\DeclareDocumentCommand{\valpha}{}{\varalpha}
\DeclareDocumentCommand{\vbeta}{}{\varbeta}
\DeclareDocumentCommand{\vgamma}{}{\vargamma}
\DeclareDocumentCommand{\vdelta}{}{\vardelta}
\DeclareDocumentCommand{\vepsilon}{}{\varepsilon}
\DeclareDocumentCommand{\vzeta}{}{\varzeta}
\DeclareDocumentCommand{\veta}{}{\vareta}
\DeclareDocumentCommand{\vtheta}{}{\vartheta}
\DeclareDocumentCommand{\viota}{}{\variota}
\DeclareDocumentCommand{\vkappa}{}{\varkappa}
\DeclareDocumentCommand{\vlambda}{}{\varlambda}
\DeclareDocumentCommand{\vmu}{}{\varmu}
\DeclareDocumentCommand{\vnu}{}{\varnu}
\DeclareDocumentCommand{\vxi}{}{\varxi}
\DeclareDocumentCommand{\vomicron}{}{\varomicron}
\DeclareDocumentCommand{\vpi}{}{\varpi}
\DeclareDocumentCommand{\vrho}{}{\varrho}
\DeclareDocumentCommand{\vsigma}{}{\varsigma}
\DeclareDocumentCommand{\vtau}{}{\vartau}
\DeclareDocumentCommand{\vupsilon}{}{\varupsilon}
\DeclareDocumentCommand{\vphi}{}{\varphi}
\DeclareDocumentCommand{\vchi}{}{\varchi}
\DeclareDocumentCommand{\vpsi}{}{\varpsi}
\DeclareDocumentCommand{\vomega}{}{\varomega}
\DeclareDocumentCommand{\uAlpha}{}{\upAlpha}
\DeclareDocumentCommand{\uBeta}{}{\upBeta}
\DeclareDocumentCommand{\uGamma}{}{\upGamma}
\DeclareDocumentCommand{\uDelta}{}{\upDelta}
\DeclareDocumentCommand{\uEpsilon}{}{\upEpsilon}
\DeclareDocumentCommand{\uZeta}{}{\upZeta}
\DeclareDocumentCommand{\uEta}{}{\upEta}
\DeclareDocumentCommand{\uTheta}{}{\upTheta}
\DeclareDocumentCommand{\uIota}{}{\upIota}
\DeclareDocumentCommand{\uKappa}{}{\upKappa}
\DeclareDocumentCommand{\uLambda}{}{\upLambda}
\DeclareDocumentCommand{\uMu}{}{\upMu}
\DeclareDocumentCommand{\uNu}{}{\upNu}
\DeclareDocumentCommand{\uXi}{}{\upXi}
\DeclareDocumentCommand{\uOmicron}{}{\upOmicron}
\DeclareDocumentCommand{\uPi}{}{\upPi}
\DeclareDocumentCommand{\uRho}{}{\upRho}
\DeclareDocumentCommand{\uSigma}{}{\upSigma}
\DeclareDocumentCommand{\uTau}{}{\upTau}
\DeclareDocumentCommand{\uUpsilon}{}{\upUpsilon}
\DeclareDocumentCommand{\uPhi}{}{\upPhi}
\DeclareDocumentCommand{\uChi}{}{\upChi}
\DeclareDocumentCommand{\uPsi}{}{\upPsi}
\DeclareDocumentCommand{\uOmega}{}{\upOmega}
\DeclareDocumentCommand{\ualpha}{}{\upalpha}
\DeclareDocumentCommand{\ubeta}{}{\upbeta}
\DeclareDocumentCommand{\ugamma}{}{\upgamma}
\DeclareDocumentCommand{\udelta}{}{\updelta}
\DeclareDocumentCommand{\uepsilon}{}{\upepsilon}
\DeclareDocumentCommand{\uzeta}{}{\upzeta}
\DeclareDocumentCommand{\ueta}{}{\upeta}
\DeclareDocumentCommand{\utheta}{}{\uptheta}
\DeclareDocumentCommand{\uiota}{}{\upiota}
\DeclareDocumentCommand{\ukappa}{}{\upkappa}
\DeclareDocumentCommand{\ulambda}{}{\uplambda}
\DeclareDocumentCommand{\umu}{}{\upmu}
\DeclareDocumentCommand{\unu}{}{\upnu}
\DeclareDocumentCommand{\uxi}{}{\upxi}
\DeclareDocumentCommand{\uomicron}{}{\upomicron}
\DeclareDocumentCommand{\upi}{}{\uppi}
\DeclareDocumentCommand{\urho}{}{\uprho}
\DeclareDocumentCommand{\usigma}{}{\upsigma}
\DeclareDocumentCommand{\utau}{}{\uptau}
\DeclareDocumentCommand{\uupsilon}{}{\upupsilon}
\DeclareDocumentCommand{\uphi}{}{\upphi}
\DeclareDocumentCommand{\uchi}{}{\upchi}
\DeclareDocumentCommand{\upsi}{}{\uppsi}
\DeclareDocumentCommand{\uomega}{}{\upomega}
\DeclareDocumentCommand{\uvAlpha}{}{\upvarAlpha}
\DeclareDocumentCommand{\uvBeta}{}{\upvarBeta}
\DeclareDocumentCommand{\uvGamma}{}{\upvarGamma}
\DeclareDocumentCommand{\uvDelta}{}{\upvarDelta}
\DeclareDocumentCommand{\uvEpsilon}{}{\upvarEpsilon}
\DeclareDocumentCommand{\uvZeta}{}{\upvarZeta}
\DeclareDocumentCommand{\uvEta}{}{\upvarEta}
\DeclareDocumentCommand{\uvTheta}{}{\upvarTheta}
\DeclareDocumentCommand{\uvIota}{}{\upvarIota}
\DeclareDocumentCommand{\uvKappa}{}{\upvarKappa}
\DeclareDocumentCommand{\uvLambda}{}{\upvarLambda}
\DeclareDocumentCommand{\uvMu}{}{\upvarMu}
\DeclareDocumentCommand{\uvNu}{}{\upvarNu}
\DeclareDocumentCommand{\uvXi}{}{\upvarXi}
\DeclareDocumentCommand{\uvOmicron}{}{\upvarOmicron}
\DeclareDocumentCommand{\uvPi}{}{\upvarPi}
\DeclareDocumentCommand{\uvRho}{}{\upvarRho}
\DeclareDocumentCommand{\uvSigma}{}{\upvarSigma}
\DeclareDocumentCommand{\uvTau}{}{\upvarTau}
\DeclareDocumentCommand{\uvUpsilon}{}{\upvarUpsilon}
\DeclareDocumentCommand{\uvPhi}{}{\upvarPhi}
\DeclareDocumentCommand{\uvChi}{}{\upvarChi}
\DeclareDocumentCommand{\uvPsi}{}{\upvarPsi}
\DeclareDocumentCommand{\uvOmega}{}{\upvarOmega}
\DeclareDocumentCommand{\uvalpha}{}{\upvaralpha}
\DeclareDocumentCommand{\uvbeta}{}{\upvarbeta}
\DeclareDocumentCommand{\uvgamma}{}{\upvargamma}
\DeclareDocumentCommand{\uvdelta}{}{\upvardelta}
\DeclareDocumentCommand{\uvepsilon}{}{\upvarepsilon}
\DeclareDocumentCommand{\uvzeta}{}{\upvarzeta}
\DeclareDocumentCommand{\uveta}{}{\upvareta}
\DeclareDocumentCommand{\uvtheta}{}{\upvartheta}
\DeclareDocumentCommand{\uviota}{}{\upvariota}
\DeclareDocumentCommand{\uvkappa}{}{\upvarkappa}
\DeclareDocumentCommand{\uvlambda}{}{\upvarlambda}
\DeclareDocumentCommand{\uvmu}{}{\upvarmu}
\DeclareDocumentCommand{\uvnu}{}{\upvarnu}
\DeclareDocumentCommand{\uvxi}{}{\upvarxi}
\DeclareDocumentCommand{\uvomicron}{}{\upvaromicron}
\DeclareDocumentCommand{\uvpi}{}{\upvarpi}
\DeclareDocumentCommand{\uvrho}{}{\upvarrho}
\DeclareDocumentCommand{\uvsigma}{}{\upvarsigma}
\DeclareDocumentCommand{\uvtau}{}{\upvartau}
\DeclareDocumentCommand{\uvupsilon}{}{\upvarupsilon}
\DeclareDocumentCommand{\uvphi}{}{\upvarphi}
\DeclareDocumentCommand{\uvchi}{}{\upvarchi}
\DeclareDocumentCommand{\uvpsi}{}{\upvarpsi}
\DeclareDocumentCommand{\uvomega}{}{\upvaromega}
\fi

% Others
\DeclareDocumentCommand{\autommode}{m}{\relax\ifmmode #1\else\(#1\)\fi}
\let\amm\autommode
\DeclareDocumentCommand{\mathcolorbox}{ m m }{
  \begingroup
  \setlength{\fboxsep}{0pt}
  \mathchoice
    {\colorbox{#1}{$\displaystyle#2$}}
    {\colorbox{#1}{$\textstyle#2$}}
    {\colorbox{#1}{$\scriptstyle#2$}}
    {\colorbox{#1}{$\scriptscriptstyle#2$}}
  \endgroup
}
\let\mcbox\mathcolorbox
\DeclareDocumentCommand{\autocolorbox}{m m}{
  \relax\ifmmode \mathcolorbox{#1}{#2}\else\colorbox{#1}{#2}\fi
}
\let\acbox\autocolorbox
\let\cbox\autocolorbox
\DeclareDocumentCommand{\tentothepowerof}{m}{\relax\ifmmode 10^{#1}\else\(10^{#1}\)\fi}
\let\tenpow\tentothepowerof
\DeclareDocumentCommand{\scientificnotation}{m m}{\relax\ifmmode #1\times 10^{#2}\else\(#1\times 10^{#2}\)\fi}
\let\scinote\scientificnotation

% Symbols
\DeclareDocumentCommand\lparen{}{(} % Left parenthesis
\DeclareDocumentCommand\rparen{}{)} % Right parenthesis
\DeclareDocumentCommand\ordersymbol{}{\mathcal{O}} % Order symbol --> O(x^2)
\DeclareDocumentCommand{\typical}{}{\cbox{cyan}{\phantom{A}}}
\DeclareDocumentCommand{\tall}{}{\cbox{cyan}{\phantom{A^{\vphantom{x^x}}_x}}}
\DeclareDocumentCommand{\grande}{}{\cbox{cyan}{\phantom{\frac{1}{xx}}}}
\DeclareDocumentCommand{\venti}{}{\cbox{cyan}{\phantom{\sum_x^x}}}
\DeclareDocumentCommand\Vtextvisiblespace{O{.3em}}{\mbox{\kern.06em\vrule height.3ex}\vbox{\hrule width#1}\hbox{\vrule height.3ex}}

% Brackets and braces
\DeclareDocumentCommand{\PHquantity}{ t\big t\Big t\bigg t\Bigg o d() d|| g }
{ % Flexible automatic bracketing of an expression in () or [] or {} or ||
  % Handles manual override of sizing
  \IfBooleanTF{#1}{\let\ltag\bigl \let\rtag\bigr}{
    \IfBooleanTF{#2}{\let\ltag\Bigl \let\rtag\Bigr}{
      \IfBooleanTF{#3}{\let\ltag\biggl \let\rtag\biggr}{
        \IfBooleanTF{#4}{\let\ltag\Biggl \let\rtag\Biggr}{\let\ltag\left \let\rtag\right}
      }
    }
  }
  % Handles actual bracketing
  \IfNoValueTF{#5}{
    \IfNoValueTF{#6}{
    \IfNoValueTF{#7}{
    \IfNoValueTF{#8}{
      \IfBooleanTF{#1}{\big}{
      \IfBooleanTF{#2}{\Big}{
        \IfBooleanTF{#3}{\bigg}{
        \IfBooleanTF{#4}{\Bigg}{}
        }
      }
      }
    }
    {\ltag\lbrace#8\rtag\rbrace}
    }{
    \ltag\lvert{#7}\rtag\rvert
    \IfNoValueTF{#8}{}{#8}
    }
  }{
    \ltag(#6\rtag)
    \IfNoValueTF{#7}{}{|#7|}
    \IfNoValueTF{#8}{}{#8}
  }
  }{
  \ltag[#5\rtag]
  \IfNoValueTF{#6}{}{(#6)}
  \IfNoValueTF{#7}{}{|#7|}
  \IfNoValueTF{#8}{}{#8}
  }
}
\let\PHqty\PHquantity
\IfPackageLoadedTF{siunitx}
{
  \DeclareDocumentCommand{\ITquantity}{ t\big t\Big t\bigg t\Bigg o d() d|| g g }
  { % integrate \qty from siunitx into \qty
    \IfValueTF{#9}
    { % \qty from siunitx
    \IfValueTF{#5}
    {\SI[#5]{#8}{#9}}
    {\SI{#8}{#9}}
    }{ % \qty from physics
    % Handles manual override of sizing
    \IfBooleanTF{#1}{\let\ltag\bigl \let\rtag\bigr}{
      \IfBooleanTF{#2}{\let\ltag\Bigl \let\rtag\Bigr}{
      \IfBooleanTF{#3}{\let\ltag\biggl \let\rtag\biggr}{
        \IfBooleanTF{#4}{\let\ltag\Biggl \let\rtag\Biggr}{\let\ltag\left \let\rtag\right}
      }
      }
    }
    % Handles actual bracketing
    \IfNoValueTF{#5}{
      \IfNoValueTF{#6}{
      \IfNoValueTF{#7}{
        \IfNoValueTF{#8}{
        \IfBooleanTF{#1}{\big}{
          \IfBooleanTF{#2}{\Big}{
          \IfBooleanTF{#3}{\bigg}{
            \IfBooleanTF{#4}{\Bigg}{}
          }
          }
        }
        }
        {\ltag\lbrace#8\rtag\rbrace}
      }{
        \ltag\lvert{#7}\rtag\rvert
        \IfNoValueTF{#8}{}{#8}
      }
      }{
      \ltag(#6\rtag)
      \IfNoValueTF{#7}{}{|#7|}
      \IfNoValueTF{#8}{}{#8}
      }
    }{
      \ltag[#5\rtag]
      \IfNoValueTF{#6}{}{(#6)}
      \IfNoValueTF{#7}{}{|#7|}
      \IfNoValueTF{#8}{}{#8}
    }
    }
  }
  \let\ITqty\ITquantity
  \ifsiintegrate
    \let\PTquantity\ITquantity
  \else
    \let\PTquantity\PHquantity
  \fi
}{\let\PTquantity\PHquantity}
\let\PTqty\PTquantity
\ifoverride
  \let\qty\PTquantity
  \let\quantity\PTquantity
\fi
\DeclareDocumentCommand\pqty{ l m }{\braces#1{\lparen}{\rparen}{#2}}
\DeclareDocumentCommand\bqty{ l m }{\braces#1{\lbrack}{\rbrack}{#2}}
\DeclareDocumentCommand\Bqty{ l m }{\braces#1{\lbrace}{\rbrace}{#2}}
\DeclareDocumentCommand\vqty{ l m }{\braces#1{\lvert}{\rvert}{#2}}
 \DeclareDocumentCommand\omqty{m}{\begin{matrix}#1\end{matrix}}
\DeclareDocumentCommand\pmqty{m}{\begin{pmatrix}#1\end{pmatrix}}
\DeclareDocumentCommand\PTpmqty{s m}{\IfNoValueTF{#1}{\begin{pmatrix}#2\end{pmatrix}}{\left\lgroup\begin{matrix}#2\end{matrix}\right\rgroup}}
\ifoverride\let\pmqty\PTpmqty\fi
\DeclareDocumentCommand\Pmqty{m}{\left\lgroup\begin{matrix}#1\end{matrix}\right\rgroup}
\DeclareDocumentCommand\bmqty{m}{\begin{bmatrix}#1\end{bmatrix}}
\DeclareDocumentCommand\vmqty{m}{\begin{vmatrix}#1\end{vmatrix}}
\DeclareDocumentCommand\PTmatrixquantity{ s g o d() d|| }
{
  \IfNoValueTF{#2}
  {
    \IfNoValueTF{#3}
    {
      \IfNoValueTF{#4}
      {
        \vmqty{#5}
      }
      {
        \IfBooleanTF{#1}
        {\Pmqty{#4}}
        {\pmqty{#4}}
        \IfNoValueTF{#5}{}{|#5|}
      }
    }
    {
      \bmqty{#3}
      \IfNoValueTF{#4}{}{(#4)}
      \IfNoValueTF{#5}{}{|#5|}}
    }
  {
    \omqty{#2}
    \IfNoValueTF{#3}{}{[#3]}
    \IfNoValueTF{#4}{}{(#4)}
    \IfNoValueTF{#5}{}{|#5|}
  }
}
\let\PTmqty\PTmatrixquantity
\ifoverride\let\mqty\PTmatrixquantity\fi
\DeclareDocumentCommand\matrixdeterminant{m}{\vmqty{#1}} % Matrix determinant
\DeclareDocumentCommand\mdet{}{\matrixdeterminant} % Shorthand for matrix determinant

\DeclareDocumentCommand\somqty{m}{\begin{smallmatrix}#1\end{smallmatrix}}
\DeclareDocumentCommand\spmqty{m}{\pqty{\begin{smallmatrix}#1\end{smallmatrix}}}
\DeclareDocumentCommand\PTspmqty{s m}{\IfNoValueTF{#1}{\pqty{\begin{smallmatrix}#2\end{smallmatrix}}}{\left\lgroup\begin{smallmatrix}#2\end{smallmatrix}\right\rgroup}}
\ifoverride\let\spmqty\PTspmqty\fi
\DeclareDocumentCommand\sPmqty{m}{\left\lgroup\begin{smallmatrix}#1\end{smallmatrix}\right\rgroup}
\DeclareDocumentCommand\sbmqty{m}{\bqty{\begin{smallmatrix}#1\end{smallmatrix}}}
\DeclareDocumentCommand\svmqty{m}{\vqty{\begin{smallmatrix}#1\end{smallmatrix}}}
\DeclareDocumentCommand\PTsmallmatrixquantity{ s g o d() d|| }
{
  \IfNoValueTF{#2}
  {
    \IfNoValueTF{#3}
    {
      \IfNoValueTF{#4}
      {
        \svmqty{#5}
      }
      {
        \IfBooleanTF{#1}
        {\sPmqty{#4}}
        {\spmqty{#4}}
        \IfNoValueTF{#5}{}{|#5|}
      }
    }
    {
      \sbmqty{#3}
      \IfNoValueTF{#4}{}{(#4)}
      \IfNoValueTF{#5}{}{|#5|}}
    }
  {
    \somqty{#2}
    \IfNoValueTF{#3}{}{[#3]}
    \IfNoValueTF{#4}{}{(#4)}
    \IfNoValueTF{#5}{}{|#5|}
  }
}
\let\PTsmqty\PTsmallmatrixquantity
\ifoverride\let\smqty\PTsmallmatrixquantity\fi
\DeclareDocumentCommand\smallmatrixdeterminant{m}{\svmqty{#1}} % Small matrix determinant
\DeclareDocumentCommand\smdet{}{\smallmatrixdeterminant} % Shorthand for small matrix determinant

\DeclareDocumentCommand\argopen{s}{\IfBooleanTF{#1}{\mathopen{}\mathclose\bgroup}{\mathopen{}\mathclose\bgroup\left}} % Special open grouping for argument of a function
\DeclareDocumentCommand\argclose{s}{\IfBooleanTF{#1}{\egroup}{\aftergroup\egroup\right}} % Special close grouping for argument of a function

\DeclareDocumentCommand\braces{ s t\big t\Big t\bigg t\Bigg m m m }
{ % General braces with automatic and manual sizing
  \IfBooleanTF{#1}
  {\left#6\smash{#8}\right#7\vphantom{#8}}
  {
  \IfBooleanTF{#2}{\bigl#6{#8}\bigr#7}{
    \IfBooleanTF{#3}{\Bigl#6{#8}\Bigr#7}{
    \IfBooleanTF{#4}{\biggl#6{#8}\biggr#7}{
      \IfBooleanTF{#5}{\Biggl#6{#8}\Biggr#7}{\left#6{#8}\right#7}
    }
    }
  }
  }
}

\DeclareDocumentCommand\fbraces{ s t\big t\Big t\bigg t\Bigg m m m m }
{ % Function braces with automatic and manual sizing
  #8
  \IfBooleanTF{#1}
  {\argopen#6\smash{#9}\argclose#7\vphantom{#9}}
  {
  \IfBooleanTF{#2}{\argopen*\bigl#6{#9}\argclose*\bigr#7}{
    \IfBooleanTF{#3}{\argopen*\Bigl#6{#9}\argclose*\Bigr#7}{
    \IfBooleanTF{#4}{\argopen*\biggl#6{#9}\argclose*\biggr#7}{
      \IfBooleanTF{#5}
      {\argopen*\Biggl#6{#9}\argclose*\Biggr#7}
      {\argopen#6{#9}\argclose#7}
    }
    }
  }
  }
}

\DeclareDocumentCommand\absolutevalue{ l m }{\braces#1{\lvert}{\rvert}{#2}} % Absolute value/complex modulus
\DeclareDocumentCommand\abs{}{\absolutevalue} % Shorthand for \absolutevalue
\DeclareDocumentCommand\norm{ l m }{\braces#1{\lVert}{\rVert}{#2}} % Norm
\DeclareDocumentCommand\order{ l m }{\fbraces#1{\lparen}{\rparen}{\ordersymbol}{#2}} % Order notation -> O(x^2)

\DeclareDocumentCommand\evaluated{ s g d[| d(| }
{ % Vertical evaluation bar
  \IfNoValueTF{#2}
  {
    \IfNoValueTF{#3}
    {
      \IfNoValueTF{#4}
      {
        \argopen.\vphantom{\int}\argclose\rvert
      }
      {
        \IfBooleanTF{#1}{\vphantom{#4}}{}
        \left(\IfBooleanTF{#1}{\smash{#4}}{#4}\vphantom{\int}\right\rvert
      }
    }
    {
      \IfBooleanTF{#1}{\vphantom{#3}}{}
      \left[\IfBooleanTF{#1}{\smash{#3}}{#3}\vphantom{\int}\right\rvert
      \IfNoValueTF{#4}{}{(#4|}
    }
  }
  {
    \IfBooleanTF{#1}{\vphantom{#2}}{}
    \left.\IfBooleanTF{#1}{\smash{#2}}{#2}\vphantom{\int}\right\rvert
    \IfNoValueTF{#3}{}{[#3|}
    \IfNoValueTF{#4}{}{(#4|}
  }
}
\DeclareDocumentCommand\eval{}{\evaluated} % Shorthand for evaluated

\DeclareDocumentCommand\poissonbracket{ l m m }{\braces#1{\lbrace}{\rbrace}{#2,#3}} % Poisson bracket [same as anti-commutator]
\DeclareDocumentCommand\pb{}{\poissonbracket} % Shorthand for \poissonbracket

% Commutators
\DeclareDocumentCommand\commutator{ l m m }{\braces#1{\lbrack}{\rbrack}{#2,#3}} % Commutator
\DeclareDocumentCommand\comm{}{\commutator} % Shorthand for \commutator
\DeclareDocumentCommand\anticommutator{ l m m }{\braces#1{\lbrace}{\rbrace}{#2,#3}} % Anticommutator [same as Poisson bracket]
\DeclareDocumentCommand\acommutator{}{\anticommutator} % Shorthand for \anticommutator
\DeclareDocumentCommand\acomm{}{\anticommutator} % Shorthand for \anticommutator

% Vector notation
\DeclareDocumentCommand\vectorbold{ s m }{\IfBooleanTF{#1}{\boldsymbol{#2}}{\mathbf{#2}}} % Vector bold [star for Greek and italic Roman]
\DeclareDocumentCommand\vb{}{\vectorbold} % Shorthand for \vectorbold

\DeclareDocumentCommand\vectorarrow{ s m }{\IfBooleanTF{#1}{\vec{\boldsymbol{#2}}}{\vec{\mathbf{#2}}}} % Vector arrow + bold [star for Greek and italic Roman]
\DeclareDocumentCommand\va{}{\vectorarrow} % Shorthand for \vectorarrow

\DeclareDocumentCommand\vectorunit{ s m }{\IfBooleanTF{#1}{\boldsymbol{\hat{#2}}}{\mathbf{\hat{#2}}}} % Unit vector [star for Greek and italic Roman]
\DeclareDocumentCommand\vu{}{\vectorunit} % Shorthand for \vectorunit

\DeclareDocumentCommand\dotproduct{}{\boldsymbol\cdot} % Vector dot product symbol
\DeclareDocumentCommand\vdot{}{\dotproduct} % Shorthand for \dotproduct [note that the command sequence \dp is protected]

\DeclareDocumentCommand\crossproduct{}{\boldsymbol\times} % Vector cross product symbol
\DeclareDocumentCommand\cross{}{\crossproduct} % Shorthand for \crossproduct
\DeclareDocumentCommand\cp{}{\crossproduct} % Shorthand for \crossproduct

\DeclareDocumentCommand\gradient{ g o d() }{ % Gradient
  \IfNoValueTF{#1}{
  \IfNoValueTF{#2}{
    \IfNoValueTF{#3}{\vnabla}{\fbraces{\lparen}{\rparen}{\vnabla}{#3}}
  }
  {\fbraces{\lbrack}{\rbrack}{\vnabla}{#2} \IfNoValueTF{#3}{}{(#3)}}
  }
  {\vnabla #1 \IfNoValueTF{#2}{}{[#2]} \IfNoValueTF{#3}{}{(#3)}}
}
\DeclareDocumentCommand\grad{}{\gradient} % Shorthand for \gradient

\DeclareDocumentCommand\divergence{ g o d() }{ % Divergence
  \IfNoValueTF{#1}{
  \IfNoValueTF{#2}{
    \IfNoValueTF{#3}{\vnabla \vdot}{\vnabla \vdot \quantity(#3)}
  }
  {\vnabla \vdot \quantity[#2] \IfNoValueTF{#3}{}{(#3)}}
  }
  {\vnabla \vdot #1 \IfNoValueTF{#2}{}{[#2]} \IfNoValueTF{#3}{}{(#3)}}
}
\let\divg\divergence
\iforiginaldiv
  \ifphysics
    \let\div\divisionsymbol
    \let\divg\divergence
  \else
    \let\divisionsymbol\div
  \fi
\else
  \ifphysics
    \let\div\divergence
  \else
    \let\divisionsymbol\div % Rename \div [division symbol] in order to free up control sequence for \divergence
    \let\div\divergence
  \fi
\fi

\DeclareDocumentCommand\curl{ g o d() }{ % Curl
  \IfNoValueTF{#1}{
  \IfNoValueTF{#2}{
    \IfNoValueTF{#3}{\vnabla \cross}{\vnabla \cross \quantity(#3)}
  }
  {\vnabla \cross \quantity[#2] \IfNoValueTF{#3}{}{(#3)}}
  }
  {\vnabla \cross #1 \IfNoValueTF{#2}{}{[#2]} \IfNoValueTF{#3}{}{(#3)}}
}

\DeclareDocumentCommand\laplacian{ g o d() }{ % Laplacian
  \IfNoValueTF{#1}{
  \IfNoValueTF{#2}{
    \IfNoValueTF{#3}{\nabla^2}{\fbraces{\lparen}{\rparen}{\nabla^2}{#3}}
  }
  {\fbraces{\lbrack}{\rbrack}{\nabla^2}{#2} \IfNoValueTF{#3}{}{(#3)}}
  }
  {\nabla^2 #1 \IfNoValueTF{#2}{}{[#2]} \IfNoValueTF{#3}{}{(#3)}}
}

% Operators
\DeclareMathOperator{\trace}{tr} % Trace of a matrix
\DeclareMathOperator{\Trace}{Tr} % Trace of a matrix (alternate)
\DeclareMathOperator{\rank}{rank} % Rank of a matrix
\DeclareMathOperator{\erf}{erf} % Gauss error function
\DeclareMathOperator{\Residue}{Res} % Residue
\DeclareDocumentCommand\principalvalue{g}{\IfNoValueTF{#1}{\mathcal{P}}{\mathcal{P}\mathord{#1}}}
\DeclareDocumentCommand\pv{}{\principalvalue}
\DeclareDocumentCommand\PV{g}{\IfNoValueTF{#1}{\mathrm{P.V.}}{\mathrm{P.V.}\mathord{#1}}}
\let\real\Re \DeclareDocumentCommand\Re{g}{\IfNoValueTF{#1}{\operatorname{Re}}{\fbraces{\lbrace}{\rbrace}{\operatorname{Re}}{#1}}}
\let\imaginary\Im \DeclareDocumentCommand\Im{g}{\IfNoValueTF{#1}{\operatorname{Im}}{\fbraces{\lbrace}{\rbrace}{\operatorname{Im}}{#1}}}
\DeclareDocumentCommand\opbraces{ m g o d() }
{
  \IfNoValueTF{#2}
  {
  \IfNoValueTF{#3}
  {
    \IfNoValueTF{#4}
    {#1}
    {\fbraces{\lparen}{\rparen}{#1}{#4}}
  }
  {
    \fbraces{\lbrack}{\rbrack}{#1}{#3}
    \IfNoValueTF{#4}{}{(#4)}
  }
  }
  {
  \fbraces{\lbrace}{\rbrace}{#1}{#2}
  \IfNoValueTF{#3}{}{[#3]}
  \IfNoValueTF{#4}{}{(#4)}
  }
}
\DeclareDocumentCommand\trigbraces{ m o d() }
{
  \IfNoValueTF{#3}
  {#1 \IfNoValueTF{#2}{}{[#2]}}
  {#1 \IfNoValueTF{#2}{}{^{#2}} \argopen(#3\argclose)}
}

% Trig function and operator redefinitions
\ifx\trigopt 1
  \let\sine\sin \DeclareDocumentCommand\sin{}{\trigbraces{\sine}}
  \let\cosine\cos \DeclareDocumentCommand\cos{}{\trigbraces{\cosine}}
  \let\tangent\tan \DeclareDocumentCommand\tan{}{\trigbraces{\tangent}}
  \let\cosecant\csc \DeclareDocumentCommand\csc{}{\trigbraces{\cosecant}}
  \let\secant\sec \DeclareDocumentCommand\sec{}{\trigbraces{\secant}}
  \let\cotangent\cot \DeclareDocumentCommand\cot{}{\trigbraces{\cotangent}}

  \let\arcsine\arcsin \DeclareDocumentCommand\arcsin{}{\trigbraces{\arcsine}}
  \let\arccosine\arccos \DeclareDocumentCommand\arccos{}{\trigbraces{\arccosine}}
  \let\arctangent\arctan \DeclareDocumentCommand\arctan{}{\trigbraces{\arctangent}}
  \DeclareMathOperator{\arccosecant}{arccsc}
  \DeclareDocumentCommand\arccsc{}{\trigbraces{\arccosecant}}
  \DeclareMathOperator{\arcsecant}{arcsec}
  \DeclareDocumentCommand\arcsec{}{\trigbraces{\arcsecant}}
  \DeclareMathOperator{\arccotangent}{arccot}
  \DeclareDocumentCommand\arccot{}{\trigbraces{\arccotangent}}

  \DeclareMathOperator{\asine}{asin}
  \DeclareDocumentCommand\asin{}{\trigbraces{\asine}}
  \DeclareMathOperator{\acosine}{acos}
  \DeclareDocumentCommand\acos{}{\trigbraces{\acosine}}
  \DeclareMathOperator{\atangent}{atan}
  \DeclareDocumentCommand\atan{}{\trigbraces{\atangent}}
  \DeclareMathOperator{\acosecant}{acsc}
  \DeclareDocumentCommand\acsc{}{\trigbraces{\acosecant}}
  \DeclareMathOperator{\asecant}{asec}
  \DeclareDocumentCommand\asec{}{\trigbraces{\asecant}}
  \DeclareMathOperator{\acotangent}{acot}
  \DeclareDocumentCommand\acot{}{\trigbraces{\acotangent}}

  \let\hypsine\sinh \DeclareDocumentCommand\sinh{}{\trigbraces{\hypsine}}
  \let\hypcosine\cosh \DeclareDocumentCommand\cosh{}{\trigbraces{\hypcosine}}
  \let\hyptangent\tanh \DeclareDocumentCommand\tanh{}{\trigbraces{\hyptangent}}
  \DeclareMathOperator{\hypcosecant}{csch}
  \DeclareDocumentCommand\csch{}{\trigbraces{\hypcosecant}}
  \DeclareMathOperator{\hypsecant}{sech}
  \DeclareDocumentCommand\sech{}{\trigbraces{\hypsecant}}
  \let\hypcotangent\coth \DeclareDocumentCommand\coth{}{\trigbraces{\hypcotangent}}

  \let\exponential\exp \DeclareDocumentCommand\exp{}{\opbraces{\exponential}}
  \let\logarithm\log \DeclareDocumentCommand\log{}{\trigbraces{\logarithm}}
  \let\naturallogarithm\ln \DeclareDocumentCommand\ln{}{\trigbraces{\naturallogarithm}}
  \let\determinant\det \DeclareDocumentCommand\det{}{\opbraces{\determinant}}
  \let\Probability\Pr \DeclareDocumentCommand\Pr{}{\opbraces{\Probability}}
  \DeclareDocumentCommand\tr{}{\opbraces{\trace}}
  \DeclareDocumentCommand\Tr{}{\opbraces{\Trace}}
  \DeclareDocumentCommand\Res{}{\opbraces{\Residue}}
\else
  \DeclareMathOperator{\arccsc}{arccsc}
  \DeclareMathOperator{\arcsec}{arcsec}
  \DeclareMathOperator{\arccot}{arccot}

  \DeclareMathOperator{\asin}{asin}
  \DeclareMathOperator{\acos}{acos}
  \DeclareMathOperator{\atan}{atan}
  \DeclareMathOperator{\acsc}{acsc}
  \DeclareMathOperator{\asec}{asec}
  \DeclareMathOperator{\acot}{acot}

  \DeclareMathOperator{\csch}{csch}
  \DeclareMathOperator{\sech}{sech}

  \DeclareDocumentCommand\tr{}{\trace}
  \DeclareDocumentCommand\Tr{}{\Trace}
  \DeclareDocumentCommand\Res{}{\Residue}
\fi

% Quick quad text (math-mode text with \quad spacing)
\DeclareDocumentCommand\qqtext{ s m }{\IfBooleanTF{#1}{}{\quad}\text{#2}\quad}
\DeclareDocumentCommand\qq{}{\qqtext}

\DeclareDocumentCommand\qcomma{}{,\quad}
\DeclareDocumentCommand\qc{}{\qcomma}

\DeclareDocumentCommand\qif{s}{\IfBooleanTF{#1}{}{\quad}\text{if}\quad}
\DeclareDocumentCommand\qthen{s}{\IfBooleanTF{#1}{}{\quad}\text{then}\quad}
\DeclareDocumentCommand\qelse{s}{\IfBooleanTF{#1}{}{\quad}\text{else}\quad}
\DeclareDocumentCommand\qotherwise{s}{\IfBooleanTF{#1}{}{\quad}\text{otherwise}\quad}
\DeclareDocumentCommand\qunless{s}{\IfBooleanTF{#1}{}{\quad}\text{unless}\quad}
\DeclareDocumentCommand\qgiven{s}{\IfBooleanTF{#1}{}{\quad}\text{given}\quad}
\DeclareDocumentCommand\qusing{s}{\IfBooleanTF{#1}{}{\quad}\text{using}\quad}
\DeclareDocumentCommand\qassume{s}{\IfBooleanTF{#1}{}{\quad}\text{assume}\quad}
\DeclareDocumentCommand\qsince{s}{\IfBooleanTF{#1}{}{\quad}\text{since}\quad}
\DeclareDocumentCommand\qlet{s}{\IfBooleanTF{#1}{}{\quad}\text{let}\quad}
\DeclareDocumentCommand\qfor{s}{\IfBooleanTF{#1}{}{\quad}\text{for}\quad}
\DeclareDocumentCommand\qall{s}{\IfBooleanTF{#1}{}{\quad}\text{all}\quad}
\DeclareDocumentCommand\qeven{s}{\IfBooleanTF{#1}{}{\quad}\text{even}\quad}
\DeclareDocumentCommand\qodd{s}{\IfBooleanTF{#1}{}{\quad}\text{odd}\quad}
\DeclareDocumentCommand\qinteger{s}{\IfBooleanTF{#1}{}{\quad}\text{integer}\quad}
\DeclareDocumentCommand\qand{s}{\IfBooleanTF{#1}{}{\quad}\text{and}\quad}
\DeclareDocumentCommand\qor{s}{\IfBooleanTF{#1}{}{\quad}\text{or}\quad}
\DeclareDocumentCommand\qas{s}{\IfBooleanTF{#1}{}{\quad}\text{as}\quad}
\DeclareDocumentCommand\qin{s}{\IfBooleanTF{#1}{}{\quad}\text{in}\quad}
\DeclareDocumentCommand\qcc{s}{\IfBooleanTF{#1}{}{\quad}\text{c.c.}\quad}

% Derivatives
\DeclareDocumentCommand\differential{ o g d() }{ % Differential 'd'
  % o: optional n for nth differential
  % g: optional argument for readability and to control spacing
  % d: long-form as in d(cos x)
  \IfNoValueTF{#2}{
  \IfNoValueTF{#3}
  {\diffd\IfNoValueTF{#1}{}{^{#1}}}
  {\mathinner{\diffd\IfNoValueTF{#1}{}{^{#1}}\argopen(#3\argclose)}}
  }
  {\mathinner{\diffd\IfNoValueTF{#1}{}{^{#1}}#2} \IfNoValueTF{#3}{}{(#3)}}
}
\DeclareDocumentCommand\dd{}{\differential} % Shorthand for \differential

\DeclareDocumentCommand\PTderivative{ s o m g d() }
{ % Total derivative
  % s: star for \flatfrac flat derivative
  % o: optional n for nth derivative
  % m: mandatory (x in df/dx)
  % g: optional (f in df/dx)
  % d: long-form d/dx(...)
  \IfBooleanTF{#1}
  {\let\fractype\flatfrac}
  {\let\fractype\frac}
  \IfNoValueTF{#4}
  {
  \IfNoValueTF{#5}
  {\fractype{\diffd \IfNoValueTF{#2}{}{^{#2}}}{\diffd #3\IfNoValueTF{#2}{}{^{#2}}}}
  {\fractype{\diffd \IfNoValueTF{#2}{}{^{#2}}}{\diffd #3\IfNoValueTF{#2}{}{^{#2}}} \argopen(#5\argclose)}
  }
  {\fractype{\diffd \IfNoValueTF{#2}{}{^{#2}} #3}{\diffd #4\IfNoValueTF{#2}{}{^{#2}}}}
  \IfNoValueTF{#5}{}{\argopen(#5\argclose)}
}
\let\PTdv\PTderivative
\ifoverride\let\dv\PTderivative\fi
\DeclareDocumentCommand\PTpartialderivative{ s o m g g d() }
{ % Partial derivative
  % s: star for \flatfrac flat derivative
  % o: optional n for nth derivative
  % m: mandatory (x in df/dx)
  % g: optional (f in df/dx)
  % g: optional (y in d^2f/dxdy)
  % d: long-form d/dx(...)
  \IfBooleanTF{#1}
  {\let\fractype\flatfrac}
  {\let\fractype\frac}
  \IfNoValueTF{#4}
  {
  \IfNoValueTF{#6}
  {\fractype{\partial \IfNoValueTF{#2}{}{^{#2}}}{\partial #3\IfNoValueTF{#2}{}{^{#2}}}}
  {\fractype{\partial \IfNoValueTF{#2}{}{^{#2}}}{\partial #3\IfNoValueTF{#2}{}{^{#2}}} \argopen(#6\argclose)}
  }
  {
  \IfNoValueTF{#5}
  {\fractype{\partial \IfNoValueTF{#2}{}{^{#2}} #3}{\partial #4\IfNoValueTF{#2}{}{^{#2}}}}
  {\fractype{\partial^2 #3}{\partial #4 \partial #5}}
  \IfNoValueTF{#6}{}{\argopen(#6\argclose)}
  }
}
\let\PTpdv\PTpartialderivative
\let\PTpderivative\PTpartialderivative
\ifoverride
  \let\pderivative\PTpartialderivative
  \let\pdv\PTpartialderivative
\fi

\DeclareDocumentCommand\variation{ o g d() }{ % Functional variation
  % o: optional n for nth differential
  % g: optional argument for readability and to control spacing
  % d: long-form as in d(F(g))
  \IfNoValueTF{#2}{
  \IfNoValueTF{#3}
  {\delta \IfNoValueTF{#1}{}{^{#1}}}
  {\mathinner{\delta \IfNoValueTF{#1}{}{^{#1}}\argopen(#3\argclose)}}
  }
  {\mathinner{\delta \IfNoValueTF{#1}{}{^{#1}}#2} \IfNoValueTF{#3}{}{(#3)}}
}
\DeclareDocumentCommand\var{}{\variation} % Shorthand for \variation

\DeclareDocumentCommand\functionalderivative{ s o m g d() }
{ % Functional derivative
  % s: star for \flatfrac flat derivative
  % o: optional n for nth derivative
  % m: mandatory (g in dF/dg)
  % g: optional (F in dF/dg)
  % d: long-form d/dx(...)
  \IfBooleanTF{#1}
  {\let\fractype\flatfrac}
  {\let\fractype\frac}
  \IfNoValueTF{#4}
  {
  \IfNoValueTF{#5}
  {\fractype{\variation \IfNoValueTF{#2}{}{^{#2}}}{\variation #3\IfNoValueTF{#2}{}{^{#2}}}}
  {\fractype{\variation \IfNoValueTF{#2}{}{^{#2}}}{\variation #3\IfNoValueTF{#2}{}{^{#2}}} \argopen(#5\argclose)}
  }
  {\fractype{\variation \IfNoValueTF{#2}{}{^{#2}} #3}{\variation #4\IfNoValueTF{#2}{}{^{#2}}}}
}
\DeclareDocumentCommand\fderivative{}{\functionalderivative} % Shorthand for \functionalderivative
\DeclareDocumentCommand\fdv{}{\functionalderivative} % Shorthand for \functionalderivative

% Bra-ket notation
\DeclareDocumentCommand\bra{ s m t\ket s g }
{ % Bra
  \IfBooleanTF{#3}
  { % Contraction
  \IfBooleanTF{#1}
  { % Bra has a star: no resize
    \IfNoValueTF{#5}
    {\braket*{#2}{} \IfBooleanTF{#4}{*}{}}
    {\braket*{#2}{#5}}
  }
  {
    \IfBooleanTF{#4}
    { % Ket has a star: no resize
    \IfNoValueTF{#5}
    {\braket{#2}{} *}
    {\braket*{#2}{#5}}
    }
    {\braket{#2}{\IfNoValueTF{#5}{}{#5}}} % Neither term is starred: auto sizing
  }
  }
  { % No contraction
  \IfBooleanTF{#1}
  {\vphantom{#2}\left\langle\smash{#2}\right\rvert}
  {\left\langle{#2}\right\rvert}
  \IfBooleanTF{#4}{*}{}
  \IfNoValueTF{#5}{}{#5}
  }
}

\DeclareDocumentCommand\ket{ s m }
{ % Ket
  \IfBooleanTF{#1}
  {\vphantom{#2}\left\lvert\smash{#2}\right\rangle} % No resize
  {\left\lvert{#2}\right\rangle} % Auto sizing
}

\DeclareDocumentCommand\innerproduct{ s m g }
{ % Inner product
  \IfBooleanTF{#1}
  { % No resize
  \IfNoValueTF{#3}
  {\vphantom{#2}\left\langle\smash{#2}\middle\vert\smash{#2}\right\rangle}
  {\vphantom{#2#3}\left\langle\smash{#2}\middle\vert\smash{#3}\right\rangle}
  }
  { % Auto resize
  \IfNoValueTF{#3}
  {\left\langle{#2}\middle\vert{#2}\right\rangle}
  {\left\langle{#2}\middle\vert{#3}\right\rangle}
  }
}
\DeclareDocumentCommand\braket{}{\innerproduct} % Alternative for \innerproduct
\DeclareDocumentCommand\ip{}{\innerproduct} % Shorthand for \innerproduct

\DeclareDocumentCommand\outerproduct{ s m g }
{ % Dyad
  \IfBooleanTF{#1}
  { % No resize
  \IfNoValueTF{#3}
  {\vphantom{#2}\left\lvert\smash{#2}\middle\rangle\!\middle\langle\smash{#2}\right\rvert}
  {\vphantom{#2#3}\left\lvert\smash{#2}\middle\rangle\!\middle\langle\smash{#3}\right\rvert}
  }
  { % Auto resize
  \IfNoValueTF{#3}
  {\left\lvert{#2}\middle\rangle\!\middle\langle{#2}\right\rvert}
  {\left\lvert{#2}\middle\rangle\!\middle\langle{#3}\right\rvert}
  }
}
\DeclareDocumentCommand\dyad{}{\outerproduct} % Alternative for \outerproduct
\DeclareDocumentCommand\op{}{\dyad} % Shorthand for \outerproduct
\DeclareDocumentCommand\ketbra{}{\dyad} % Alternative for \outerproduct

\DeclareDocumentCommand\expectationvalue{ s s m g }
{ % Expectation value
  \IfNoValueTF{#4}
  {
  \IfBooleanTF{#1}
  {\vphantom{#3}\left\langle\smash{#3}\right\rangle} % Starred implicit form: no resizing
  {\left\langle{#3}\right\rangle} % Normal implicit form: auto sizing
  }
  {
  \IfBooleanTF{#1}
  {
    \IfBooleanTF{#2}
    {\left\langle{#4}\middle\vert{#3}\middle\vert{#4}\right\rangle} % Double starred explicit form: total auto sizing
    {\vphantom{#3#4}\left\langle\smash{#4}\middle\vert\smash{#3}\middle\vert\smash{#4}\right\rangle} % Starred explicit form: no resizing
  }
  {\vphantom{#3}\left\langle{#4}\middle\vert\smash{#3}\middle\vert{#4}\right\rangle} % Normal explicit form: only resize based on bra/ket arguments
  }
}
\DeclareDocumentCommand\expval{}{\expectationvalue} % Shorthand for \expectationvalue
\DeclareDocumentCommand\ev{}{\expectationvalue} % Shorthand for \expectationvalue
\DeclareDocumentCommand\vev{ m }{\expectationvalue{#1}{0}} % Vacuum expectation value

\DeclareDocumentCommand\matrixelement{ s s m m m }
{ % Matrix element
  \IfBooleanTF{#1}
  {
  \IfBooleanTF{#2}
  {\left\langle{#3}\middle\vert{#4}\middle\vert{#5}\right\rangle} % Double starred: total resizing
  {\vphantom{#3#4#5}\left\langle\smash{#3}\middle\vert\smash{#4}\middle\vert\smash{#5}\right\rangle} % Starred: no resizing
  }
  {\vphantom{#4}\left\langle{#3}\middle\vert\smash{#4}\middle\vert{#5}\right\rangle} % Normal: only resize based on bra/ket arguments
}
\DeclareDocumentCommand\matrixel{}{\matrixelement} % Shorthand for \matrixelement
\DeclareDocumentCommand\mel{}{\matrixelement} % Shorthand for \matrixelement

% Matrix macros
\DeclareDocumentCommand\identitymatrix{m}
{
{
\newtoks\matrixtoks
\global\matrixtoks = {}
\newcount\rowcount
\newcount\colcount
\loop
\colcount = 0
\advance \rowcount by 1
  {
  \loop
  \advance \colcount by 1
  \edef\addtoks
  {
    \ifnum \colcount = 1 \else & \fi
    \ifnum \colcount = \rowcount 1 \else 0 \fi
  }
  \global\matrixtoks = \expandafter{\the\expandafter\matrixtoks\addtoks}
  \ifnum \colcount < #1
  \repeat
  }
\ifnum \rowcount < #1
\global\matrixtoks = \expandafter{\the\matrixtoks \\ }
\repeat
}
\the\matrixtoks
}
\DeclareDocumentCommand\imat{}{\identitymatrix}

\DeclareDocumentCommand\PTxmatrix{ s o m m m o o g g }
{
  {
    \newtoks\matrixtoks
    \global\matrixtoks = {}

    \newcount\rowcount
    \newcount\actualrow
    \newcount\rowdots
    \IfValueTF{#6}{
      \actualrow = #6
      \IfValueTF{#2}{
        \IfStrEq{#2}{1}{\rowdots = \numexpr\actualrow\relax}{
          \IfStrEq{#2}{0}{\rowdots = \numexpr\actualrow\relax}{\rowdots = \numexpr\actualrow-1\relax}
        }
      }{
        \IfBlankTF{#4}
        {\rowdots = \numexpr\actualrow-1\relax}
        {
          \ifnum\actualrow = #4
            \rowdots = 0
          \else
            \rowdots = \numexpr\actualrow-1\relax
          \fi
        }
      }
    }{
      \IfBlankTF{#4}{
        \actualrow = 1
      }{
        \actualrow = #4
      }
      \rowdots = 0
    }

    \newcount\colcount
    \newcount\actualcol
    \newcount\coldots
    \IfValueTF{#7}{
      \actualcol = #7
      \IfValueTF{#2}{
        \IfStrEq{#2}{2}{\coldots = \numexpr\actualcol\relax}{
          \IfStrEq{#2}{0}{\coldots = \numexpr\actualcol\relax}{\coldots = \numexpr\actualcol-1\relax}
        }
      }{
        \IfBlankTF{#5}
        {\coldots = \numexpr\actualcol-1\relax}
        {
          \ifnum\actualcol = #5
            \coldots = 0
          \else
            \coldots = \numexpr\actualcol-1\relax
          \fi
        }
      }
    }{
      \IfBlankTF{#5}{
        \actualcol = 1
      }{
        \actualcol = #5
      }
      \coldots = 0
    }
    
    \loop
      \colcount = 0
      \advance \rowcount by 1
      {
        \loop
          \advance \colcount by 1
          \edef\addtoks{
            \ifnum\colcount = 1
            \else
              &
            \fi
            \ifnum\colcount = \coldots
              \ifnum\rowcount = \rowdots
                \ddots
              \else
                \ldots
              \fi
            \else
              \ifnum\rowcount = \rowdots
                \vdots
              \else
                #3
                \IfBooleanTF{#1}{_{
                  \ifnum\actualrow = \rowcount
                    \IfValueTF{#8}{#8}{
                      \IfBlankTF{#4}{}{
                        \ifnum #4 > 1
                          #4
                        \fi
                      }
                    }
                  \else
                    \the\rowcount
                  \fi
                  \ifnum\actualcol = \colcount
                    \IfValueTF{#9}{#9}{
                      \IfBlankTF{#5}{}{
                        \ifnum #5 > 1
                          #5
                        \fi
                      }
                    }
                  \else
                    \the\colcount
                  \fi
                }}{}
              \fi
            \fi
          }
        \global\matrixtoks = \expandafter{\the\expandafter\matrixtoks\addtoks}
        \ifnum \colcount < \actualcol
          \repeat
      }
    \ifnum \rowcount < \actualrow
      \global\matrixtoks = \expandafter{\the\expandafter\matrixtoks \\}
      \repeat
  }
  \the\matrixtoks
}
\let\PTxmat\PTxmatrix
\ifoverride\let\xmat\PTxmatrix\fi

\DeclareDocumentCommand\zeromatrix{ m g }{\IfNoValueTF{#2}{\PTxmatrix{0}{#1}{#1}}{\PTxmatrix{0}{#1}{#2}}}
\DeclareDocumentCommand\zmat{}{\zeromatrix}

\DeclareDocumentCommand\paulixmatrix{}{0&1\\1&0}
\DeclareDocumentCommand\pauliymatrix{}{0&-i\\i&0}
\DeclareDocumentCommand\paulizmatrix{}{1&0\\0&-1}
\DeclareDocumentCommand\paulimatrix{m}
{
  \let\argin=#1
  \ifx\argin 0 \identitymatrix{2} \else
  \ifx\argin 1 \paulixmatrix \else
    \ifx\argin 2 \pauliymatrix \else
    \ifx\argin 3 \paulizmatrix \else
      \ifx\argin x \paulixmatrix \else
      \ifx\argin y \pauliymatrix \else
        \ifx\argin z \paulizmatrix \fi\fi\fi\fi\fi\fi\fi
}
\DeclareDocumentCommand\pmat{}{\paulimatrix}

\DeclareDocumentCommand\PTdmat{ m m g g g g g g g }
{
\newtoks\matrixtoks
\global\matrixtoks = {}
\IfNoValueTF{#3}
{#2}
{
  \IfNoValueTF{#4}
  {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1\\#1&\PTmqty{#3}}}
  {
  \IfNoValueTF{#5}
  {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1\\#1&\PTmqty{#3}&#1\\#1&#1&\PTmqty{#4}}}
  {
    \IfNoValueTF{#6}
    {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1&#1\\#1&\PTmqty{#3}&#1&#1\\#1&#1&\PTmqty{#4}&#1\\#1&#1&#1&\PTmqty{#5}}}
    {
    \IfNoValueTF{#7}
    {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1&#1&#1\\#1&\PTmqty{#3}&#1&#1&#1\\#1&#1&\PTmqty{#4}&#1&#1\\#1&#1&#1&\PTmqty{#5}&#1\\#1&#1&#1&#1&\PTmqty{#6}}}
    {
      \IfNoValueTF{#8}
      {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1&#1&#1&#1\\#1&\PTmqty{#3}&#1&#1&#1&#1\\#1&#1&\PTmqty{#4}&#1&#1&#1\\#1&#1&#1&\PTmqty{#5}&#1&#1\\#1&#1&#1&#1&\PTmqty{#6}&#1\\#1&#1&#1&#1&#1&\PTmqty{#7}}}
      {
      \IfNoValueTF{#9}
      {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1&#1&#1&#1&#1\\#1&\PTmqty{#3}&#1&#1&#1&#1&#1\\#1&#1&\PTmqty{#4}&#1&#1&#1&#1\\#1&#1&#1&\PTmqty{#5}&#1&#1&#1\\#1&#1&#1&#1&\PTmqty{#6}&#1&#1\\#1&#1&#1&#1&#1&\PTmqty{#7}&#1\\#1&#1&#1&#1&#1&#1&\PTmqty{#8}}}
      {\global\matrixtoks = \expandafter{\PTmqty{#2}&#1&#1&#1&#1&#1&#1&#1\\#1&\PTmqty{#3}&#1&#1&#1&#1&#1&#1\\#1&#1&\PTmqty{#4}&#1&#1&#1&#1&#1\\#1&#1&#1&\PTmqty{#5}&#1&#1&#1&#1\\#1&#1&#1&#1&\PTmqty{#6}&#1&#1&#1\\#1&#1&#1&#1&#1&\PTmqty{#7}&#1&#1\\#1&#1&#1&#1&#1&#1&\PTmqty{#8}&#1\\#1&#1&#1&#1&#1&#1&#1&\PTmqty{#9}}}
      }
    }
    }
  }
  }
}
\the\matrixtoks
}
\DeclareDocumentCommand\diagonalmatrix{O{} >{\SplitList{,}}m }{\PTdmat{#1}#2}
\DeclareDocumentCommand\dmat{}{\diagonalmatrix}

\DeclareDocumentCommand\PTadmat{mmggggggg}
{
\newtoks\matrixtoks
\global\matrixtoks = {}
\IfNoValueTF{#3}
{#2}
{
  \IfNoValueTF{#4}
  {\global\matrixtoks = \expandafter{#1&\PTmqty{#2}\\\PTmqty{#3}&#1}}
  {
  \IfNoValueTF{#5}
  {\global\matrixtoks = \expandafter{#1&#1&\PTmqty{#2}\\#1&\PTmqty{#3}&#1\\\PTmqty{#4}&#1&#1}}
  {
    \IfNoValueTF{#6}
    {\global\matrixtoks = \expandafter{#1&#1&#1&\PTmqty{#2}\\#1&#1&\PTmqty{#3}&#1\\#1&\PTmqty{#4}&#1&#1\\\PTmqty{#5}&#1&#1&#1}}
    {
    \IfNoValueTF{#7}
    {\global\matrixtoks = \expandafter{#1&#1&#1&#1&\PTmqty{#2}\\#1&#1&#1&\PTmqty{#3}&#1\\#1&#1&\PTmqty{#4}&#1&#1\\#1&\PTmqty{#5}&#1&#1&#1\\\PTmqty{#6}&#1&#1&#1&#1}}
    {
      \IfNoValueTF{#8}
      {\global\matrixtoks = \expandafter{#1&#1&#1&#1&#1&\PTmqty{#2}\\#1&#1&#1&#1&\PTmqty{#3}&#1\\#1&#1&#1&\PTmqty{#4}&#1&#1\\#1&#1&\PTmqty{#5}&#1&#1&#1\\#1&\PTmqty{#6}&#1&#1&#1&#1\\\PTmqty{#7}&#1&#1&#1&#1&#1}}
      {
      \IfNoValueTF{#9}
      {\global\matrixtoks = \expandafter{#1&#1&#1&#1&#1&#1&\PTmqty{#2}\\#1&#1&#1&#1&#1&\PTmqty{#3}&#1\\#1&#1&#1&#1&\PTmqty{#4}&#1&#1\\#1&#1&#1&\PTmqty{#5}&#1&#1&#1\\#1&#1&\PTmqty{#6}&#1&#1&#1&#1\\#1&\PTmqty{#7}&#1&#1&#1&#1&#1\\\PTmqty{#8}&#1&#1&#1&#1&#1&#1}}
      {\global\matrixtoks = \expandafter{#1&#1&#1&#1&#1&#1&#1&\PTmqty{#2}\\#1&#1&#1&#1&#1&#1&\PTmqty{#3}&#1\\#1&#1&#1&#1&#1&\PTmqty{#4}&#1&#1\\#1&#1&#1&#1&\PTmqty{#5}&#1&#1&#1\\#1&#1&#1&\PTmqty{#6}&#1&#1&#1&#1\\#1&#1&\PTmqty{#7}&#1&#1&#1&#1&#1\\#1&\PTmqty{#8}&#1&#1&#1&#1&#1&#1\\\PTmqty{#9}&#1&#1&#1&#1&#1&#1&#1}}
      }
    }
    }
  }
  }
}
\the\matrixtoks
}
\DeclareDocumentCommand\antidiagonalmatrix{O{} >{\SplitList{,}}m }{\PTadmat{#1}#2}
\DeclareDocumentCommand\admat{}{\antidiagonalmatrix}

% Misc
\DeclareDocumentCommand\flatfrac{ m m }{\left.#1\middle\slash#2\right.}
\DeclareDocumentCommand\homework{}{ % You can try it
  \ensuremath{
  \div{\vb{E}}=\frac{\rho}{\epsilon_0} \qc
  \div{\vb{B}}=0 \qc
  \curl{\vb{E}}=-\pdv{\vb{B}}{t}\qc
  \curl{\vb{B}}=\mu_0\vb{J}+\frac{1}{c^2}\pdv{\vb{E}}{t}\qc
  H\ket{\Psi}=i\hbar\pdv{}{t}\ket{\Psi},
  \qq{all else follows.}
  }
}